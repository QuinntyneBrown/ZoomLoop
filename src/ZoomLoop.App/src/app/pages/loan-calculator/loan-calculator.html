<div class="loan-calculator">
  <div class="loan-calculator__container">
    <h1 class="loan-calculator__title">Loan Calculator</h1>
    <p class="loan-calculator__subtitle">Calculate your monthly payments with our easy-to-use loan calculator</p>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="loan-form" novalidate>
      
      <!-- Price Field -->
      <div class="loan-form__field-group">
        <mat-form-field appearance="outline" class="loan-form__field">
          <mat-label>Vehicle Price *</mat-label>
          <span matTextPrefix>$ </span>
          <input 
            matInput
            type="number"
            id="price"
            formControlName="price"
            placeholder="25000"
            step="100"
            (blur)="onFieldBlur('price')"
            [attr.aria-invalid]="hasFieldError('price')"
            [attr.aria-describedby]="hasFieldError('price') ? 'price-error' : null"
            aria-required="true">
          <mat-error 
            id="price-error"
            *ngIf="hasFieldError('price')"
            role="alert">
            {{ getFieldError('price') }}
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Down Payment Field -->
      <div class="loan-form__field-group">
        <mat-form-field appearance="outline" class="loan-form__field">
          <mat-label>Down Payment *</mat-label>
          <span matTextPrefix>$ </span>
          <input 
            matInput
            type="number"
            id="downPayment"
            formControlName="downPayment"
            placeholder="5000"
            step="100"
            (blur)="onFieldBlur('downPayment')"
            [attr.aria-invalid]="hasFieldError('downPayment')"
            [attr.aria-describedby]="hasFieldError('downPayment') ? 'downPayment-error' : null"
            aria-required="true">
          <mat-error 
            id="downPayment-error"
            *ngIf="hasFieldError('downPayment')"
            role="alert">
            {{ getFieldError('downPayment') }}
          </mat-error>
        </mat-form-field>
      </div>

      <!-- APR Field -->
      <div class="loan-form__field-group">
        <mat-form-field appearance="outline" class="loan-form__field">
          <mat-label>APR (Annual Percentage Rate) *</mat-label>
          <input 
            matInput
            type="number"
            id="apr"
            formControlName="apr"
            placeholder="5.5"
            step="0.1"
            min="0"
            [max]="config.maxAPR"
            (blur)="onFieldBlur('apr')"
            [attr.aria-invalid]="hasFieldError('apr')"
            [attr.aria-describedby]="hasFieldError('apr') ? 'apr-error' : null"
            aria-required="true">
          <span matTextSuffix>%</span>
          <mat-error 
            id="apr-error"
            *ngIf="hasFieldError('apr')"
            role="alert">
            {{ getFieldError('apr') }}
          </mat-error>
          <mat-hint>Interest rate ({{ config.minAPR }}% - {{ config.maxAPR }}%)</mat-hint>
        </mat-form-field>
      </div>

      <!-- Term Field -->
      <div class="loan-form__field-group">
        <mat-form-field appearance="outline" class="loan-form__field">
          <mat-label>Loan Term *</mat-label>
          <mat-select 
            id="termMonths"
            formControlName="termMonths"
            placeholder="Select term"
            (blur)="onFieldBlur('termMonths')"
            [attr.aria-invalid]="hasFieldError('termMonths')"
            [attr.aria-describedby]="hasFieldError('termMonths') ? 'termMonths-error' : null"
            aria-required="true">
            <mat-option *ngFor="let term of allowedTerms" [value]="term">
              {{ term }} months ({{ term / 12 }} years)
            </mat-option>
          </mat-select>
          <mat-error 
            id="termMonths-error"
            *ngIf="hasFieldError('termMonths')"
            role="alert">
            {{ getFieldError('termMonths') }}
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Fees Field -->
      <div class="loan-form__field-group">
        <mat-form-field appearance="outline" class="loan-form__field">
          <mat-label>Additional Fees *</mat-label>
          <span matTextPrefix>$ </span>
          <input 
            matInput
            type="number"
            id="fees"
            formControlName="fees"
            placeholder="500"
            step="50"
            (blur)="onFieldBlur('fees')"
            [attr.aria-invalid]="hasFieldError('fees')"
            [attr.aria-describedby]="hasFieldError('fees') ? 'fees-error' : null"
            aria-required="true">
          <mat-error 
            id="fees-error"
            *ngIf="hasFieldError('fees')"
            role="alert">
            {{ getFieldError('fees') }}
          </mat-error>
          <mat-hint>Documentation, registration, and other fees</mat-hint>
        </mat-form-field>
      </div>

      <!-- Form Actions -->
      <div class="loan-form__actions">
        <button 
          type="submit" 
          mat-flat-button
          color="primary"
          [disabled]="form.invalid">
          Calculate Payment
        </button>
        <button 
          type="button" 
          mat-stroked-button
          color="primary"
          (click)="reset()">
          Reset
        </button>
      </div>
    </form>

    <!-- Results Section -->
    <div 
      class="loan-results" 
      *ngIf="result()"
      role="region"
      aria-label="Loan calculation results">
      
      <div *ngIf="result()?.isValid" class="loan-results__valid">
        <h2 class="loan-results__title">Your Loan Summary</h2>
        
        <div class="loan-results__grid">
          <div class="loan-results__item loan-results__item--primary">
            <span class="loan-results__label">Monthly Payment</span>
            <span class="loan-results__value loan-results__value--large">
              ${{ (result()?.monthlyPayment ?? 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}
            </span>
          </div>

          <div class="loan-results__item">
            <span class="loan-results__label">Total Loan Amount</span>
            <span class="loan-results__value">
              ${{ (result()?.totalLoanAmount ?? 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}
            </span>
          </div>

          <div class="loan-results__item">
            <span class="loan-results__label">Total Interest</span>
            <span class="loan-results__value">
              ${{ (result()?.totalInterest ?? 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}
            </span>
          </div>

          <div class="loan-results__item">
            <span class="loan-results__label">Total Cost</span>
            <span class="loan-results__value">
              ${{ (result()?.totalCost ?? 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}
            </span>
          </div>
        </div>
      </div>

      <div 
        *ngIf="!result()?.isValid" 
        class="loan-results__error"
        role="alert"
        aria-live="polite">
        <h2 class="loan-results__error-title">Unable to Calculate</h2>
        <p class="loan-results__error-message">{{ result()?.error }}</p>
      </div>
    </div>
  </div>
</div>
