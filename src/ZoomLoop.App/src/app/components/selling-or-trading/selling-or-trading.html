<div class="selling-or-trading">
  <mat-card class="selling-or-trading__card">
    <mat-card-header>
      <mat-card-title>Selling Or Trading?</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- Stage 1: VIN Input -->
      @if (stage === 'vin-input') {
        <form [formGroup]="vinForm" (ngSubmit)="handleGetInstantOffer()" class="selling-or-trading__form">
          <mat-form-field appearance="outline" class="selling-or-trading__field">
            <mat-label>Vehicle Identification Number (VIN)</mat-label>
            <input
              matInput
              formControlName="vin"
              placeholder="Enter 17-character VIN"
              maxlength="17"
            />
            @if (vinForm.get('vin')?.hasError('required') && vinForm.get('vin')?.touched) {
              <mat-error>VIN is required</mat-error>
            }
            @if (vinForm.get('vin')?.hasError('minlength') || vinForm.get('vin')?.hasError('maxlength')) {
              <mat-error>VIN must be exactly 17 characters</mat-error>
            }
          </mat-form-field>

          @if (error) {
            <div class="selling-or-trading__error">{{ error }}</div>
          }

          <div class="selling-or-trading__button-container">
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="loading"
            >
              @if (loading) {
                <mat-spinner diameter="20"></mat-spinner>
              }
              @if (!loading) {
                <span>Get Instant Offer</span>
              }
            </button>
          </div>
        </form>
      }

      <!-- Stage 2: Details Input -->
      @if (stage === 'details-input' && vehicleInfo) {
        <div class="selling-or-trading__vehicle-info">
          <h3 class="selling-or-trading__vehicle-title">Your Vehicle</h3>
          <p class="selling-or-trading__vehicle-description">
            {{ vehicleInfo.year }} {{ vehicleInfo.make }} {{ vehicleInfo.model }}
          </p>
        </div>

        <form [formGroup]="detailsForm" (ngSubmit)="handleGetInstantQuote()" class="selling-or-trading__form">
          <mat-form-field appearance="outline" class="selling-or-trading__field">
            <mat-label>What's your postal code?</mat-label>
            <input
              matInput
              formControlName="postalCode"
              placeholder="e.g., M5H 2N2"
            />
            @if (detailsForm.get('postalCode')?.hasError('required') && detailsForm.get('postalCode')?.touched) {
              <mat-error>Postal code is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="selling-or-trading__field">
            <mat-label>How many kilometers does the vehicle have?</mat-label>
            <input
              matInput
              type="number"
              formControlName="kilometers"
              placeholder="e.g., 50000"
              min="0"
            />
            @if (detailsForm.get('kilometers')?.hasError('required') && detailsForm.get('kilometers')?.touched) {
              <mat-error>Kilometers is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="selling-or-trading__field">
            <mat-label>How many accidents?</mat-label>
            <input
              matInput
              type="number"
              formControlName="accidents"
              placeholder="e.g., 0"
              min="0"
            />
            @if (detailsForm.get('accidents')?.hasError('required') && detailsForm.get('accidents')?.touched) {
              <mat-error>Number of accidents is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="selling-or-trading__field">
            <mat-label>What's the condition of the interior?</mat-label>
            <mat-select formControlName="interiorCondition">
              @for (option of conditionOptions; track option) {
                <mat-option [value]="option">{{ option }}</mat-option>
              }
            </mat-select>
            @if (detailsForm.get('interiorCondition')?.hasError('required') && detailsForm.get('interiorCondition')?.touched) {
              <mat-error>Interior condition is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="selling-or-trading__field">
            <mat-label>What's the condition of the exterior?</mat-label>
            <mat-select formControlName="exteriorCondition">
              @for (option of conditionOptions; track option) {
                <mat-option [value]="option">{{ option }}</mat-option>
              }
            </mat-select>
            @if (detailsForm.get('exteriorCondition')?.hasError('required') && detailsForm.get('exteriorCondition')?.touched) {
              <mat-error>Exterior condition is required</mat-error>
            }
          </mat-form-field>

          @if (error) {
            <div class="selling-or-trading__error">{{ error }}</div>
          }

          <div class="selling-or-trading__button-container">
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="loading"
            >
              @if (loading) {
                <mat-spinner diameter="20"></mat-spinner>
              }
              @if (!loading) {
                <span>Get Instant Quote</span>
              }
            </button>
          </div>
        </form>
      }

      <!-- Stage 3: Result -->
      @if (stage === 'result' && valuationResult) {
        <div class="selling-or-trading__result">
          <h3 class="selling-or-trading__result-title">Your Vehicle Valuation</h3>
          <div class="selling-or-trading__fair-value">
            <span class="selling-or-trading__fair-value-label">Fair Value:</span>
            <span class="selling-or-trading__fair-value-amount">${{ valuationResult.fairValue | number:'1.2-2' }}</span>
          </div>
          <div class="selling-or-trading__explanation">
            <h4 class="selling-or-trading__explanation-title">Valuation Details</h4>
            <p class="selling-or-trading__explanation-text">{{ valuationResult.explanation }}</p>
          </div>
          <div class="selling-or-trading__button-container">
            <button
              mat-raised-button
              color="primary"
              (click)="reset()"
            >
              Get Another Quote
            </button>
          </div>
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>
